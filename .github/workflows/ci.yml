name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Check formatting and lints
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-check-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-check-
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Clippy
        run: cargo clippy --all-targets -- -D warnings

  # Build and test on multiple platforms
  build:
    name: Build (${{ matrix.name }})
    needs: [check]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - name: macos-x64
            os: macos-15-intel
            target: x86_64-apple-darwin
          - name: macos-arm64
            os: macos-latest
            target: aarch64-apple-darwin
          - name: windows-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            can_test: true
          - name: windows-arm64
            os: windows-latest
            target: aarch64-pc-windows-msvc
            can_test: false

    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-
      
      # Linux dependencies
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake
      
      # Windows dependencies - cache chocolatey packages
      - name: Cache Windows dependencies
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        id: windows-deps-cache
        with:
          path: |
            C:\ProgramData\chocolatey\lib\cmake*
            C:\ProgramData\chocolatey\lib\nasm*
            C:\Program Files\CMake
            C:\Program Files\NASM
          key: windows-deps-cmake-nasm-v1
      
      - name: Install Windows dependencies
        if: runner.os == 'Windows' && steps.windows-deps-cache.outputs.cache-hit != 'true'
        run: |
          choco install cmake nasm -y
      
      - name: Add NASM to PATH
        if: runner.os == 'Windows'
        run: echo "C:\Program Files\NASM" >> $env:GITHUB_PATH
      
      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Run tests
        if: matrix.can_test != false
        run: cargo test --release --target ${{ matrix.target }}
      
      - name: Package binary (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/vpnclient dist/
          cp config.example.json dist/
          cp README.md dist/
          tar -czvf vpnclient-${{ matrix.name }}.tar.gz -C dist .
      
      - name: Package binary (Windows)
        if: runner.os == 'Windows'
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item target/${{ matrix.target }}/release/vpnclient.exe dist/
          Copy-Item config.example.json dist/
          Copy-Item README.md dist/
          Compress-Archive -Path dist/* -DestinationPath vpnclient-${{ matrix.name }}.zip
      
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: vpnclient-${{ matrix.name }}
          path: |
            vpnclient-${{ matrix.name }}.tar.gz
            vpnclient-${{ matrix.name }}.zip

  # Build for iOS (macOS runner only)
  build-ios:
    name: Build (ios)
    needs: [check]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: macos-ios-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-ios-cargo-
      
      - name: Build iOS
        run: cargo build --release --target aarch64-apple-ios --features ffi
      
      - name: Create XCFramework
        run: |
          mkdir -p target/ios
          cp target/aarch64-apple-ios/release/libsoftether.a target/ios/
          rm -rf target/ios/SoftEtherVPN.xcframework
          xcodebuild -create-xcframework \
            -library target/ios/libsoftether.a -headers include \
            -output target/ios/SoftEtherVPN.xcframework
      
      - name: Package iOS framework
        run: |
          mkdir -p dist/libsoftether-ios
          cp -r target/ios/SoftEtherVPN.xcframework dist/libsoftether-ios/
          cp -r include dist/libsoftether-ios/
          cp FFI_GUIDE.md dist/libsoftether-ios/
          cp -r examples/ios dist/libsoftether-ios/examples
          cd dist && zip -r ../libsoftether-ios.zip libsoftether-ios
      
      - name: Upload iOS framework
        uses: actions/upload-artifact@v4
        with:
          name: libsoftether-ios
          path: libsoftether-ios.zip

  # Build for Android
  build-android:
    name: Build (android)
    needs: [check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: linux-android-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            linux-android-cargo-
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c
          add-to-path: true
      
      - name: Build Android (arm64-v8a)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
          CC_aarch64_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
          AR_aarch64_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target aarch64-linux-android --features ffi,jni
      
      - name: Build Android (armeabi-v7a)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
          CC_armv7_linux_androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
          AR_armv7_linux_androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target armv7-linux-androideabi --features ffi,jni
      
      - name: Build Android (x86_64)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang
          CC_x86_64_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang
          AR_x86_64_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target x86_64-linux-android --features ffi,jni
      
      - name: Build Android (x86)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CARGO_TARGET_I686_LINUX_ANDROID_LINKER: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang
          CC_i686_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang
          AR_i686_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target i686-linux-android --features ffi,jni
      
      - name: Package Android libraries
        run: |
          mkdir -p dist/libsoftether-android/jniLibs/arm64-v8a
          mkdir -p dist/libsoftether-android/jniLibs/armeabi-v7a
          mkdir -p dist/libsoftether-android/jniLibs/x86_64
          mkdir -p dist/libsoftether-android/jniLibs/x86
          cp target/aarch64-linux-android/release/libsoftether.so dist/libsoftether-android/jniLibs/arm64-v8a/
          cp target/armv7-linux-androideabi/release/libsoftether.so dist/libsoftether-android/jniLibs/armeabi-v7a/
          cp target/x86_64-linux-android/release/libsoftether.so dist/libsoftether-android/jniLibs/x86_64/
          cp target/i686-linux-android/release/libsoftether.so dist/libsoftether-android/jniLibs/x86/
          cp -r include dist/libsoftether-android/
          cp FFI_GUIDE.md dist/libsoftether-android/
          cp -r examples/android dist/libsoftether-android/examples
          cd dist && zip -r ../libsoftether-android.zip libsoftether-android
      
      - name: Upload Android libraries
        uses: actions/upload-artifact@v4
        with:
          name: libsoftether-android
          path: libsoftether-android.zip

  # Create release
  release:
    name: Release
    needs: [build, build-ios, build-android]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: List artifacts
        run: find artifacts -type f
      
      - name: Prepare release assets
        run: |
          mkdir -p release
          # Move all archives to release folder
          find artifacts -name "*.tar.gz" -exec mv {} release/ \;
          find artifacts -name "*.zip" -exec mv {} release/ \;
          ls -la release/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: true
          generate_release_notes: true
