name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  # Build desktop binaries
  build-desktop:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - name: macos-x64
            os: macos-15-intel
            target: x86_64-apple-darwin
          - name: macos-arm64
            os: macos-latest
            target: aarch64-apple-darwin
          - name: windows-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
          - name: windows-arm64
            os: windows-latest
            target: aarch64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-release-
      
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake
      
      - name: Install Windows dependencies
        if: runner.os == 'Windows'
        run: choco install cmake nasm -y
      
      - name: Add NASM to PATH
        if: runner.os == 'Windows'
        run: echo "C:\Program Files\NASM" >> $env:GITHUB_PATH
      
      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Package binary (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/vpnclient dist/
          cp config.example.json dist/
          cp README.md dist/
          tar -czvf vpnclient-${{ matrix.name }}.tar.gz -C dist .
      
      - name: Package binary (Windows)
        if: runner.os == 'Windows'
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item target/${{ matrix.target }}/release/vpnclient.exe dist/
          Copy-Item config.example.json dist/
          Copy-Item README.md dist/
          Compress-Archive -Path dist/* -DestinationPath vpnclient-${{ matrix.name }}.zip
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            vpnclient-${{ matrix.name }}.tar.gz
            vpnclient-${{ matrix.name }}.zip
          draft: true

  # Build iOS library
  build-ios:
    name: Build (ios)
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: macos-ios-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-ios-cargo-release-
      
      - name: Build iOS
        run: cargo build --release --target aarch64-apple-ios --features ffi
      
      - name: Create XCFramework
        run: |
          mkdir -p target/ios
          cp target/aarch64-apple-ios/release/libsoftether.a target/ios/
          rm -rf target/ios/SoftEtherVPN.xcframework
          xcodebuild -create-xcframework \
            -library target/ios/libsoftether.a -headers include \
            -output target/ios/SoftEtherVPN.xcframework
      
      - name: Package iOS framework
        run: |
          mkdir -p dist/libsoftether-ios
          cp -r target/ios/SoftEtherVPN.xcframework dist/libsoftether-ios/
          cp -r include dist/libsoftether-ios/
          cp FFI.md dist/libsoftether-ios/ || true
          cp -r examples/ios dist/libsoftether-ios/examples || true
          cd dist && zip -r ../libsoftether-ios.zip libsoftether-ios
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: libsoftether-ios.zip
          draft: true

  # Build Android library
  build-android:
    name: Build (android)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: linux-android-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            linux-android-cargo-release-
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c
          add-to-path: true
      
      - name: Build Android (arm64-v8a)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
          CC_aarch64_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
          AR_aarch64_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target aarch64-linux-android --features ffi,jni
      
      - name: Build Android (armeabi-v7a)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
          CC_armv7_linux_androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
          AR_armv7_linux_androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target armv7-linux-androideabi --features ffi,jni
      
      - name: Build Android (x86_64)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang
          CC_x86_64_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang
          AR_x86_64_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target x86_64-linux-android --features ffi,jni
      
      - name: Build Android (x86)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CARGO_TARGET_I686_LINUX_ANDROID_LINKER: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang
          CC_i686_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang
          AR_i686_linux_android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target i686-linux-android --features ffi,jni
      
      - name: Package Android libraries
        run: |
          mkdir -p dist/libsoftether-android/jniLibs/arm64-v8a
          mkdir -p dist/libsoftether-android/jniLibs/armeabi-v7a
          mkdir -p dist/libsoftether-android/jniLibs/x86_64
          mkdir -p dist/libsoftether-android/jniLibs/x86
          cp target/aarch64-linux-android/release/libsoftether.so dist/libsoftether-android/jniLibs/arm64-v8a/
          cp target/armv7-linux-androideabi/release/libsoftether.so dist/libsoftether-android/jniLibs/armeabi-v7a/
          cp target/x86_64-linux-android/release/libsoftether.so dist/libsoftether-android/jniLibs/x86_64/
          cp target/i686-linux-android/release/libsoftether.so dist/libsoftether-android/jniLibs/x86/
          cp -r include dist/libsoftether-android/
          cp FFI.md dist/libsoftether-android/ || true
          cp -r examples/android dist/libsoftether-android/examples || true
          cd dist && zip -r ../libsoftether-android.zip libsoftether-android
      
      - name: Generate checksums
        run: |
          sha256sum libsoftether-android.zip > libsoftether-android.zip.sha256
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            libsoftether-android.zip
            libsoftether-android.zip.sha256
          draft: true

  # Finalize release after all builds complete
  finalize:
    name: Finalize Release
    needs: [build-desktop, build-ios, build-android]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate release notes
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
